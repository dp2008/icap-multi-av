{% extends "base.html" %}

{% block title %}Inventory Management - MetaScanner{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Inventory Management</h1>
    <p class="page-subtitle">Verwaltung der Scan-Engines und deren Signatur-Definitionen</p>
</div>

<div class="card">
    <h2 class="card-header">Scan-Engines</h2>
    
    {% if engines %}
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Engine Name</th>
                        <th>Status</th>
                        <th>Signatur-Version</th>
                        <th>Letztes Update</th>
                        <th>Auto-Update</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for engine, data in engines.items() %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    {{ engine[0:2]|upper }}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">{{ engine|upper }}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Anti-Malware Engine</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if data.active %}
                                <span class="badge badge-success">‚úì Aktiv</span>
                            {% else %}
                                <span class="badge badge-danger">‚úó Inaktiv</span>
                            {% endif %}
                        </td>
                        <td>
                            <code style="font-size: 13px; color: #1f2937; font-weight: 500;">
                                v{{ data.signature_version }}
                            </code>
                        </td>
                        <td>
                            <span style="font-size: 13px; color: #6b7280;">
                                {{ data.last_update }}
                            </span>
                        </td>
                        <td>
                            {% if data.auto_update %}
                                <span class="badge badge-success">‚úì Aktiviert</span>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">
                                    {{ data.update_schedule }}
                                </div>
                            {% else %}
                                <span class="badge badge-warning">Manuell</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <!-- Aktivieren/Deaktivieren -->
                                <form action="{{ url_for('toggle', engine=engine) }}" method="post" style="display: inline;">
                                    <input type="hidden" name="active" value="{{ 'false' if data.active else 'true' }}">
                                    <button type="submit" class="btn {% if data.active %}btn-secondary{% else %}btn-success{% endif %}" style="padding: 6px 12px; font-size: 12px;">
                                        {% if data.active %}
                                            ‚è∏Ô∏è Deaktivieren
                                        {% else %}
                                            ‚ñ∂Ô∏è Aktivieren
                                        {% endif %}
                                    </button>
                                </form>
                                
                                <!-- Signaturen verwalten -->
                                <a href="{{ url_for('engine_signatures', engine=engine) }}" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">
                                    üìù Signaturen
                                </a>
                                
                                <!-- Jetzt aktualisieren -->
                                <form action="{{ url_for('update_engine_signatures', engine=engine) }}" method="post" style="display: inline;" onsubmit="return confirm('Signaturen f√ºr {{ engine }} jetzt aktualisieren?');">
                                    <button type="submit" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                        üîÑ Update
                                    </button>
                                </form>
                                
                                <!-- Auto-Update Toggle -->
                                <button onclick="showAutoUpdateModal('{{ engine }}', {{ 'true' if data.auto_update else 'false' }}, '{{ data.update_schedule }}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                                    ‚öôÔ∏è Auto-Update
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 6px;">
            <h3 style="margin-bottom: 12px; color: #1e40af;">‚ÑπÔ∏è Engine-Informationen</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px; color: #1f2937;">
                <div>
                    <strong>Gesamt Engines:</strong> {{ engines|length }}
                </div>
                <div>
                    <strong>Aktive Engines:</strong> {{ engines.values()|selectattr('active')|list|length }}
                </div>
                <div>
                    <strong>Auto-Update aktiviert:</strong> {{ engines.values()|selectattr('auto_update')|list|length }}
                </div>
                <div style="grid-column: 1 / -1;">
                    <strong>Hinweis:</strong> Deaktivierte Engines werden bei Scans √ºbersprungen. Regelm√§√üige Updates der Signaturen sind f√ºr optimalen Schutz essentiell.
                </div>
            </div>
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">‚öôÔ∏è</div>
            <p>Keine Engines konfiguriert</p>
        </div>
    {% endif %}
</div>

<div class="card" style="margin-top: 20px;">
    <h2 class="card-header">Engine-Beschreibungen</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">
            <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 16px;">üõ°Ô∏è ClamAV</h3>
            <p style="font-size: 14px; color: #6b7280; line-height: 1.5;">
                Open-Source Antivirus-Engine zur Erkennung von Viren, Malware, Trojanern und anderen b√∂sartigen Bedrohungen.
            </p>
        </div>
        
        <div style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">
            <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 16px;">üîç YARA</h3>
            <p style="font-size: 14px; color: #6b7280; line-height: 1.5;">
                Pattern-Matching-Engine zur Identifizierung und Klassifizierung von Malware-Samples basierend auf Regelsets.
            </p>
        </div>
        
        <div style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">
            <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 16px;">üìÑ OleTools</h3>
            <p style="font-size: 14px; color: #6b7280; line-height: 1.5;">
                Spezialisiert auf die Analyse von Microsoft Office-Dokumenten (Word, Excel, PowerPoint) und Makros.
            </p>
        </div>
        
        <div style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">
            <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 16px;">üî¨ CAPA</h3>
            <p style="font-size: 14px; color: #6b7280; line-height: 1.5;">
                Capability Analysis Tool zur Identifizierung von F√§higkeiten und Verhaltensweisen in ausf√ºhrbaren Dateien.
            </p>
        </div>
    </div>
</div>

<!-- Auto-Update Modal -->
<div id="autoUpdateModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0; margin-bottom: 20px;">Automatische Updates konfigurieren</h2>
        <form id="autoUpdateForm" method="post">
            <div class="form-group">
                <label class="form-label">Auto-Update aktivieren</label>
                <select name="enabled" class="form-control" style="width: 100%;">
                    <option value="false">Deaktiviert (Manuell)</option>
                    <option value="true">Aktiviert</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Update-Zeitplan</label>
                <select name="schedule" class="form-control" style="width: 100%;">
                    <option value="hourly">St√ºndlich</option>
                    <option value="daily">T√§glich</option>
                    <option value="weekly">W√∂chentlich</option>
                    <option value="monthly">Monatlich</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Speichern</button>
                <button type="button" onclick="closeAutoUpdateModal()" class="btn btn-secondary" style="flex: 1;">Abbrechen</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAutoUpdateModal(engine, enabled, schedule) {
    const modal = document.getElementById('autoUpdateModal');
    const form = document.getElementById('autoUpdateForm');
    
    form.action = '/inventory/' + engine + '/auto-update';
    form.querySelector('[name="enabled"]').value = enabled;
    form.querySelector('[name="schedule"]').value = schedule;
    
    modal.style.display = 'flex';
}

function closeAutoUpdateModal() {
    document.getElementById('autoUpdateModal').style.display = 'none';
}

// Close modal on background click
document.getElementById('autoUpdateModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAutoUpdateModal();
    }
});
</script>
{% endblock %}
